<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>扶養控除管理ツール</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogIzMzMzMzMzsiPjx0ZXh0IHk9IjUwJSIgeD0iNTAlIiBkeT0iLjM1ZW0iIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iNTAiIHN0eWxlPSJmaWxsOiAjZmZmZmZmOyBmb250LWZhbWlseTogc2Fucy1zZXJpZjsiPsҐPC90ZXh0Pjwvc3ZnPg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogIzMzMzMzMzsiPjx0ZXh0IHk9IjUwJSIgeD0iNTAlIiBkeT0iLjM1ZW0iIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iNTAiIHN0eWxlPSJmaWxsOiAjZmZmZmZmOyBmb250LWZhbWlseTogc2Fucy1zZXJpZjsiPsҐPC90ZXh0Pjwvc3ZnPg==">

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --danger: #e74c3c;
            --safe: #27ae60;
            --bg: #f5f6fa;
            --card-bg: #FFFFFF;
            --text: #2c3e50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 60px;
            overscroll-behavior-y: none;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 10px 16px 15px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 年選択エリア */
        .year-selector-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        select#yearSelect {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            font-size: 16px;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            outline: none;
        }
        
        select#yearSelect option {
            color: #333;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 5px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 6px;
        }

        .status-label { font-size: 13px; opacity: 0.9; }
        .status-value { font-size: 18px; font-weight: bold; font-family: 'Roboto Mono', monospace; }
        .big-number { font-size: 24px; }

        .limit-input-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        #targetLimit {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: white;
            font-size: 14px;
            text-align: right;
            width: 90px;
            padding: 2px 5px;
            margin-left: 8px;
        }

        .month-list {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .month-item {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid transparent;
        }

        .month-item:focus-within {
            border-left: 4px solid var(--accent);
        }

        .month-name {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            width: 70px; /* 少し広げる */
        }
        
        .month-sub {
            font-size: 10px;
            color: #888;
            display: block;
            font-weight: normal;
        }

        .input-wrapper {
            flex-grow: 1;
            text-align: right;
        }

        .money-input {
            width: 100%;
            border: none;
            font-size: 16px;
            text-align: right;
            outline: none;
            background: transparent;
            color: #333;
            font-family: 'Roboto Mono', monospace;
        }

        .unit { font-size: 12px; color: #888; margin-left: 5px; }
        
        .prediction-box {
            font-size: 11px;
            text-align: center;
            margin-top: 8px;
            padding: 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
            line-height: 1.4;
        }

        .action-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px auto;
        }

        .btn {
            background: white;
            border: 1px solid #ddd;
            color: #555;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            border-color: var(--accent);
            color: var(--accent);
        }

    </style>
</head>
<body>

<header>
    <div class="year-selector-area">
        <select id="yearSelect" onchange="changeYear()">
            </select>
        <span style="font-size:14px; font-weight:bold; margin-left:5px;">年度</span>
    </div>

    <div class="limit-input-container">
        <span>年間上限設定:</span>
        <input type="number" id="targetLimit" value="1030000" onchange="saveAndCalculate()">
    </div>

    <div class="status-card">
        <div class="status-row">
            <span class="status-label">現在の合計</span>
            <span class="status-value" id="currentTotal">0</span>
        </div>
        <div style="border-top:1px solid rgba(255,255,255,0.1); margin:4px 0;"></div>
        
        <div class="status-row">
            <span class="status-label">残月あたり目安</span>
            <span class="status-value big-number" id="monthlySafeLimit">---</span>
        </div>
        
        <div id="predictionBox" class="prediction-box">
            データ不足
        </div>
    </div>
</header>

<div class="month-list" id="monthList">
    </div>

<div class="action-area">
    <button class="btn btn-primary" onclick="exportJson()">JSON出力</button>
    <button class="btn" onclick="resetData()">この年度を削除</button>
</div>

<script>
    // 12月始まりのロジック
    // 例：2026年度 = 2025年12月 ～ 2026年11月
    const monthOrder = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
    
    let currentYear = new Date().getFullYear();
    // もし現在が12月なら、感覚的には来年度の入力かもしれないので、デフォルトを調整してもいいが
    // ここでは単純に「起動時の西暦」をデフォルトとする
    
    function init() {
        setupYearSelector();
        renderMonths();
        loadData();
    }

    function setupYearSelector() {
        const select = document.getElementById('yearSelect');
        const thisYear = new Date().getFullYear();
        // 前後3年分くらいを生成
        for (let y = thisYear - 2; y <= thisYear + 3; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.text = y;
            if (y === thisYear) option.selected = true;
            select.appendChild(option);
        }
        currentYear = parseInt(select.value);
    }

    function changeYear() {
        const select = document.getElementById('yearSelect');
        currentYear = parseInt(select.value);
        // 画面再描画
        renderMonths(); 
        loadData();
    }

    function renderMonths() {
        const container = document.getElementById('monthList');
        container.innerHTML = '';
        
        monthOrder.forEach(month => {
            // 年の表示計算（12月は前年、1-11月は選択した年）
            let displayYear = (month === 12) ? currentYear - 1 : currentYear;

            const div = document.createElement('div');
            div.className = 'month-item';
            div.innerHTML = `
                <div class="month-name">
                    ${month}月
                    <span class="month-sub">${displayYear}年</span>
                </div>
                <div class="input-wrapper">
                    <input type="number" class="money-input" id="m${month}" placeholder="-" inputmode="numeric" oninput="saveAndCalculate()">
                </div>
                <span class="unit">円</span>
            `;
            container.appendChild(div);
        });
    }

    function saveAndCalculate() {
        const target = parseInt(document.getElementById('targetLimit').value) || 0;
        let currentTotal = 0;
        let filledMonths = 0;
        
        // データ収集と保存
        // キー名を「fuyo_2026_m12」のように年度付きにする
        monthOrder.forEach(month => {
            const input = document.getElementById(`m${month}`);
            const val = input.value;
            const key = `fuyo_${currentYear}_m${month}`;

            if (val !== "") {
                const numVal = parseInt(val);
                currentTotal += numVal;
                filledMonths++;
                localStorage.setItem(key, val);
            } else {
                localStorage.removeItem(key);
            }
        });

        localStorage.setItem(`fuyo_${currentYear}_target`, target);

        // 計算ロジック
        const remainingMonths = 12 - filledMonths;
        const remainingBudget = target - currentTotal;
        
        document.getElementById('currentTotal').innerText = currentTotal.toLocaleString() + " 円";

        const safeLimitEl = document.getElementById('monthlySafeLimit');
        if (remainingMonths > 0) {
            const safePerMonth = Math.floor(remainingBudget / remainingMonths);
            safeLimitEl.innerText = safePerMonth.toLocaleString() + " 円";
            
            if (safePerMonth < 0) {
                safeLimitEl.style.color = "#ff8a80"; 
            } else {
                safeLimitEl.style.color = "#ffffff";
            }
        } else {
            safeLimitEl.innerText = "期間終了";
        }

        // 予測
        const predBox = document.getElementById('predictionBox');
        if (filledMonths > 0) {
            const average = currentTotal / filledMonths;
            const predictedTotal = currentTotal + (average * remainingMonths);
            const diff = predictedTotal - target;

            if (diff > 0) {
                predBox.innerHTML = `⚠️ 注意: 現在のペース(${Math.floor(average).toLocaleString()}円/月)では<br>年間 <strong>${Math.floor(diff).toLocaleString()}円</strong> 超過する見込みです`;
                predBox.style.background = "rgba(231, 76, 60, 0.6)"; 
            } else {
                const margin = Math.abs(diff);
                predBox.innerHTML = `✅ 順調: 現在のペースなら<br>年間 <strong>${Math.floor(margin).toLocaleString()}円</strong> の余裕があります`;
                predBox.style.background = "rgba(39, 174, 96, 0.6)"; 
            }
        } else {
            predBox.innerHTML = "入力データから年末着地見込を判定します";
            predBox.style.background = "rgba(0,0,0,0.2)";
        }
    }

    function loadData() {
        // 現在選択されている年度のデータをロード
        const savedTarget = localStorage.getItem(`fuyo_${currentYear}_target`);
        if (savedTarget) {
            document.getElementById('targetLimit').value = savedTarget;
        } else {
            // 新しい年度でデータがない場合はデフォルト103万
            document.getElementById('targetLimit').value = 1030000;
        }

        monthOrder.forEach(month => {
            const val = localStorage.getItem(`fuyo_${currentYear}_m${month}`);
            const input = document.getElementById(`m${month}`);
            if (val !== null) {
                input.value = val;
            } else {
                input.value = "";
            }
        });
        
        // 計算実行（表示更新のため）
        saveAndCalculate();
    }

    function resetData() {
        if(confirm(`${currentYear}年度のデータを全て削除しますか？\n(他の年度のデータは消えません)`)){
            // その年度のキーだけ削除
            monthOrder.forEach(month => {
                localStorage.removeItem(`fuyo_${currentYear}_m${month}`);
            });
            localStorage.removeItem(`fuyo_${currentYear}_target`);
            
            location.reload();
        }
    }

    // JSONエクスポート機能
    function exportJson() {
        const exportData = {};
        
        // localStorage内の当アプリ関連データ(fuyo_で始まるもの)を全て収集
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('fuyo_')) {
                exportData[key] = localStorage.getItem(key);
            }
        }

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        // ファイル名に日付をつける
        const dateStr = new Date().toISOString().slice(0,10);
        downloadAnchorNode.setAttribute("download", `fuyo_backup_${dateStr}.json`);
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // 起動
    init();
</script>
</body>
</html>